<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="Goonhilly HAMTV Earth Station Power Control">
<meta name="author" content="Phil Crump M0DNY">
<title>GHY99 Power Control</title>
<link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
<link rel="icon" type="image/png" href="assets/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="assets/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="assets/manifest.json">
<link href="assets/bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet">
<style>
.btn:hover, .btn:focus {                                                        
    outline : none;                                                             
    -moz-outline : none;                                                        
} 
</style>
</head>
<body>
<div id="page-container" class="container">
<div class="page-header">
  <h1>Goonhilly #99 HAMTV Earth Station Power Control - Maintenance</h1>
  <a href="/">&lt;- back</a>
</div>
<div>

<h2>Device Information</h2>
<div id="device-info">loading</div>

<h2>Device Firmware</h2>
<b>Current Version:</b> <span id="fw-current-version">checking..</span>
<a href="https://netswitch.philcrump.co.uk/fw/versions.txt" target="_blank">Version history</a>
<br><br>
<button type="button" id="button-checkfwupdate" class="btn btn-lg btn-info disabled">Check for Updates</button>

<h2>Device Reboot</h2>
<b>Device Uptime:</b> <span id="device-uptime">loading..</span>
<button type="button" id="button-reboot" class="btn btn-lg btn-danger">Reboot Device</button>

</div>
</div>
</body>
<script src="assets/jquery-3.1.1.min.js"></script>
<script src="assets/bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script>
var current_fw = null;
var reboot_req_state = 0;
function load_uptime()
{
    $.getJSON("api/device_uptime.lua")
        .done(function(data)
        {
            $('#device-uptime').text(data.up+"s ("+((data.idle/data.up)*100)+"% idle)");
        })
        .fail(function(obj)
        {
            $('#device-uptime').text("Loading failed");
            console.log("Loading failed");
        }
    );
}
function load_device_info()
{
    $.getJSON("api/device_info.lua")
        .done(function(data)
        {
            var device_info_content = $('<div></div>');
            device_info_content.append($('<b></b>').text('Device Platform: '));
            device_info_content.append($('<span></span>').text(data.platform));
            device_info_content.append($('<br />')).append($('<br />'));
            device_info_content.append($('<b></b>').text('GPIO Outputs: '));
            data.outputs.forEach(function(gpio,index)
            {
                index+=1;
                device_info_content.append($('<b></b>').text('Output '+index+': '));
                device_info_content.append($('<span></span>').text('pin '+gpio));
                if(index!=data.outputs.length)
                    device_info_content.append($('<span></span>').text(', '));
                    
            });
            $('#device-info').empty();
            $('#device-info').append(device_info_content);
        })
        .fail(function(obj)
        {
            $('#device-info').text("Load failed");
            console.log("Load failed");
        }
    );
}
function check_fw_version()
{
    $.getJSON("api/fw_version.lua")
        .done(function(data)
        {
            $('#fw-current-version').text(data.t+" ("+data.g+")");
            current_fw = data;
            $('#button-checkfwupdate').removeClass('disabled');
        })
        .fail(function(obj)
        {
            $('#fw-current-version').text("Check failed");
            console.log("Check failed");
        }
    );
}
function check_fw_updates()
{
    $('#button-checkfwupdate').text("Checking for firmware update..");
    $('#button-checkfwupdate').addClass('disabled');
    
    $.getJSON("https://netswitch.philcrump.co.uk/fw/"+current_fw.p+"/latest.json")
        .done(function(data)
        {
            if(data.g==current_fw.g)
            {
                $('#button-checkfwupdate').text('Up to date');
                $('#button-checkfwupdate').removeClass('disabled');
            }
            else
            {
                $('#button-checkfwupdate')
                    .removeClass('btn-info')
                    .addClass('btn-success')
                    .text('Update available - click to continue');
                
                $('#button-checkfwupdate').click(function(event)
                {
                    event.preventDefault();
                    if($('#button-checkfwupdate').hasClass("disabled"))
                        return;
                    $('#button-checkfwupdate')
                        .addClass('disabled')
                        .text('Starting update..');
                    update_device(data.g);
                });
            }
        })
        .fail(function(obj)
        {
            console.log("Check failed");
        }
    );
}
function update_device(gitref)
{
    $.post("api/update.lua", {update: "update", gitref: gitref})
        .done(function(data)
        {
            $('#button-checkfwupdate')
                        .text('Update started.');
            // Start polling some json for updates??
        })
        .fail(function(obj)
        {
            $('#button-checkfwupdate')
                .removeClass('disabled')
                .addClass('btn-danger')
                .text('Update failed.');
        }
    );
}
function reboot_device()
{
    $.post("api/reboot.lua", {reboot: "reboot"})
        .done(function(data)
        {
            $('#button-reboot').addClass('disabled').text('Device rebooting..');
        })
        .fail(function(obj)
        {
            $('#button-reboot').text('Device reboot failed.');
        }
    );
}
$(function () {
    load_device_info();
    load_uptime();
    check_fw_version();
    
    $('#button-checkfwupdate').click(function(event)
    {
        event.preventDefault();
        if(!$('#button-checkfwupdate').hasClass("disabled"))
            check_fw_updates();
    });
    
    $('#button-reboot').click(function(event)
    {
        event.preventDefault();
        switch(reboot_req_state)
        {
            case 0:
                reboot_req_state = 1;
                $('#button-reboot').addClass('disabled').text('Wait to confirm (1s)..');
                setTimeout(function()
                {
                    reboot_req_state = 2;
                    $('#button-reboot').removeClass('disabled').text('Click to confirm reboot');
                },1000);
                break;
            case 1:
                break;
            case 2:
                reboot_device();
                break;
            default:
                reboot_req_state = 0;
        }
    });
});
</script>
</html>
