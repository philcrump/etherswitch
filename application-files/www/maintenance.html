<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="Goonhilly HAMTV Earth Station Power Control">
<meta name="author" content="Phil Crump M0DNY">
<title>GHY99 Power Control</title>
<link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
<link rel="icon" type="image/png" href="assets/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="assets/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="assets/manifest.json">
<link href="assets/bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet">
<style>
.btn:hover, .btn:focus {                                                        
    outline : none;                                                             
    -moz-outline : none;                                                        
} 
</style>
</head>
<body>
<div id="page-container" class="container">
<div class="page-header">
  <h1>Goonhilly #99 HAMTV Earth Station Power Control</h1>
  <a href="/">&lt;- back</a>
</div>
<div>

<h2>Device Firmware</h2>
Current Version: <span id="fw-current-version">checking..</span><br>
<a href="https://netswitch.philcrump.co.uk/fw/versions.txt" target="_blank">Version history</a><br>
<button type="button" id="button-checkfwupdate" class="btn btn-lg btn-info disabled">Check for Updates</button>

<h2>Device Reboot</h2>
<button type="button" id="button-reboot" class="btn btn-lg btn-danger">Reboot Device</button>

</div>
</div>
</body>
<script src="assets/jquery-3.1.1.min.js"></script>
<script src="assets/bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script>
var current_fw = null;
function check_fw_version()
{
    $.getJSON("api/fw_version.lua")
        .done(function(data)
        {
            $('#fw-current-version').text(data.t+" ("+data.g+")");
            current_fw = data;
            $('#button-checkfwupdate').removeClass('disabled');
        })
        .fail(function(obj)
        {
            $('#fw-current-version').text("Check failed");
            console.log("Check failed");
        }
    );
}
function check_fw_updates()
{
    $('#button-checkfwupdate').text("Checking for firmware update..");
    $('#button-checkfwupdate').addClass('disabled');
    
    $.getJSON("https://netswitch.philcrump.co.uk/fw/"+current_fw.p+"/latest.json")
        .done(function(data)
        {
            if(data.g==current_fw.g)
            {
                $('#button-checkfwupdate').text('Up to date');
                $('#button-checkfwupdate').removeClass('disabled');
            }
            else
            {
                $('#button-checkfwupdate')
                    .removeClass('btn-info')
                    .addClass('btn-success')
                    .text('Update available - click to continue');
                
                $('#button-checkfwupdate').click(function(event)
                {
                    event.preventDefault();
                    if($('#button-checkfwupdate').hasClass("disabled"))
                        return;
                    $('#button-checkfwupdate')
                        .addClass('disabled')
                        .text('Starting update..');
                    update_device(data.g);
                });
            }
        })
        .fail(function(obj)
        {
            console.log("Check failed");
        }
    );
}
function update_device(gitref)
{
    $.post("api/update.lua", {update: "update", gitref: gitref})
        .done(function(data)
        {
            $('#button-checkfwupdate')
                        .text('Update started.');
            // Start polling some json for updates??
        })
        .fail(function(obj)
        {
            $('#button-checkfwupdate')
                .removeClass('disabled')
                .addClass('btn-danger')
                .text('Update failed.');
        }
    );
}
function reboot_device()
{
    $.post("api/reboot.lua", {reboot: "reboot"})
        .done(function(data)
        {
            $('#button-reboot').addClass('disabled').text('Device rebooting..');
        })
        .fail(function(obj)
        {
            $('#button-reboot').text('Device reboot failed.');
        }
    );
}
$(function () {
    check_fw_version();
    
    $('#button-checkfwupdate').click(function(event)
    {
        event.preventDefault();
        if(!$('#button-checkfwupdate').hasClass("disabled"))
            check_fw_updates();
    });
    
    $('#button-reboot').click(function(event)
    {
        event.preventDefault();
        reboot_device();
    });
});
</script>
</html>
