<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="Goonhilly HAMTV Earth Station Power Control">
<meta name="author" content="Phil Crump M0DNY">
<title>GHY99 Power Control</title>
<link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
<link rel="icon" type="image/png" href="assets/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="assets/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="assets/manifest.json">
<link href="assets/bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet">
<style>
.btn {
    margin-left: 20px;
}
.relay-status-label {
    font-size: 1.5em;
}
.relay-status {
    display: inline-block;
    margin-left: 12px;
    width: 35px;
    font-size: 1.5em;
    font-weight: bold;
}
.connection-state-error {
    color: red;
}
.action-on {
    background-color: #5cb85c;
    color: #fff;
    padding-right: 0.3em;
    padding-left: 0.3em;
    border-radius: .25em;
}
.action-off {
    background-color: #d9534f;
    color: #fff;
    padding-right: 0.3em;
    padding-left: 0.3em;
    border-radius: .25em;
}
.action-boot {
    background-color: #5bc0de;
    color: #fff;
    padding-right: 0.3em;
    padding-left: 0.3em;
    border-radius: .25em;
}
</style>
</head>
<body>
<div class="container">
<div class="page-header">
  <h1>Goonhilly HAMTV Earth Station Power Control</h1>
  Last updated: <span id="state_updated">updating..</span>
</div>
<div class="row">
 <div class="col-sm-6">
   <div id="relay1" class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Minitioune Computer</h3>
    </div>
    <div class="panel-body">
      <span class="relay-status-label">Current Status: </span><span id="relay1_status" class="relay-status"></span>
      <button type="button" class="btn btn-lg btn-danger disabled" id="btn_relay1_off">Off</button>
      <button type="button" class="btn btn-lg btn-success disabled" id="btn_relay1_on">On</button>
      <br>
      <hr>
      <h5>Action Log:</h5>
      <ul id="relay1_actionlog">
      </ul>
    </div>
   </div>
 </div>
 <div class="col-sm-6">
   <div id="relay2" class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Minitioune USB Receiver</h3>
    </div>
    <div class="panel-body">
      <span class="relay-status-label">Current Status: </span><span id="relay2_status" class="relay-status"></span>
      <button type="button" class="btn btn-lg btn-danger disabled" id="btn_relay2_off">Off</button>
      <button type="button" class="btn btn-lg btn-success disabled" id="btn_relay2_on">On</button>
      <br>
      <hr>
      <h5>Action Log:</h5>
      <ul id="relay2_actionlog">
      </ul>
    </div>
  </div>
 </div>
</div>
</div>
</body>
<script src="assets/jquery-3.1.1.min.js"></script>
<script src="assets/bootstrap-3.3.7/js/bootstrap.min.js"></script>
<script>
var state_updating = true;
var state_error = false;
var state_updated = new Date();
function relays_state()
{
    $.getJSON("api/state.lua")
        .done(function(data)
        {
            update_state(data);
        })
        .fail(function(obj)
        {
            state_error = true;
            stateTextUpdate();
            console.log("State Update failed");
        }
    );
}
function relay_action(path)
{
    $.getJSON("api/"+path+".lua")
        .done(function(data)
        {
            update_state(data);
        })
        .fail(function(obj)
        {
            state_error = true;
            stateTextUpdate();
            console.log("State Action failed");
        }
    );
}

function iso8601ToTimestamp(iso8601)
{
    var d = new Date(iso8601);
    return d.toLocaleDateString()+" "+d.toLocaleTimeString();
}

function formatTimeSince(secondsPast)
{
    if(secondsPast < 60)
    {
        return secondsPast + 's ago';
    }
    if(secondsPast < 3600)
    {
        return parseInt(secondsPast/60) + 'm ago';
    }
    return parseInt(secondsPast/3600) + 'h ago';
}

function stateTextUpdate()
{
    var now = new Date();
    var seconds = parseInt((now.getTime() - state_updated.getTime()) / 1000);
    
    if(!state_updating && !state_error)
    {
        if(seconds>=30)
        {
            state_updating = true;
            if(state_error)
            {
                state_error = false;
                $("#state_updated").removeClass("connection-state-error");
            }
            $("#state_updated").text("updating..");
            /* Update state */
            relays_state();
        }
        else
        {
            $("#state_updated").text(formatTimeSince(seconds));
        }
    }
    else if(state_error)
    {
        $("#state_updated").text("connection error").addClass("connection-state-error");
    }
}
function stateUpdateTick()
{
    stateTextUpdate();
    setTimeout(stateUpdateTick, 1000);
}

function update_state(state)
{
    if(state["1"] == 0)
    {
        $("#relay1").removeClass("panel-success").addClass("panel-danger");
        $("#btn_relay1_off").addClass("disabled");
        $("#btn_relay1_on").removeClass("disabled");
        $("#relay1_status").text("Off");
    }
    else
    {
        $("#relay1").removeClass("panel-danger").addClass("panel-success");
        $("#btn_relay1_on").addClass("disabled");
        $("#btn_relay1_off").removeClass("disabled");
        $("#relay1_status").text("On");
    }
        
    if(state["2"] == 0)
    {
        $("#relay2").removeClass("panel-success").addClass("panel-danger");
        $("#btn_relay2_off").addClass("disabled");
        $("#btn_relay2_on").removeClass("disabled");
        $("#relay2_status").text("Off");
    }
    else
    {
        $("#relay2").removeClass("panel-danger").addClass("panel-success");
        $("#btn_relay2_on").addClass("disabled");
        $("#btn_relay2_off").removeClass("disabled");
        $("#relay2_status").text("On");
    }
    
    $("#relay1_actionlog").empty();
    $("#relay2_actionlog").empty();
    var log_lengths = {"1":0, "2":0};
    state["log"].forEach(function(e, i)                                    
    {
        log_lengths[e.split("|")[1]]++;
    });
    var log_starts = {
        "1": Math.max(0, log_lengths["1"]-30),
        "2": Math.max(0, log_lengths["2"]-30)
    };
    var log_counts = {"1":0, "2":0};
    state["log"].forEach(function(e, i)
    {
        var row = e.split("|");
        var action;
        var action_class;
        switch(row[2])
        {
            case "1":
                action = "On";
                action_class = "action-on";
                break;
            case "0":
                action = "Off";
                action_class = "action-off";
                break;
            case "b":
                action = "Device Boot";
                action_class = "action-boot";
                break;
        }
        switch(row[1])
        {
            case "1":
                log_counts["1"]++;
                if(log_counts["1"]<log_starts["1"])
                    return;
                $("#relay1_actionlog").prepend($("<li></li>")
                    .text(iso8601ToTimestamp(row[0])+": ")
                    .append(
                        $("<span></span>").addClass(action_class).text(action)
                    )
                );
                break;
            case "2":
                log_counts["2"]++;                                         
                if(log_counts["2"]<log_starts["2"])                        
                    return;
                $("#relay2_actionlog").prepend($("<li></li>")                                        
                    .text(iso8601ToTimestamp(row[0])+": ")
                    .append(
                        $("<span></span>").addClass(action_class).text(action)
                    )
                );                                                                                 
                break;
        }
    });
    /* Update timestamp for 'state updated' text */
    state_updated = new Date();
    state_updating = false;
    /* Force update */
    stateTextUpdate();
}

$(function () {
    /* Load initial state */
    relays_state();
    
    /* Set up button handler */
    $(".btn").click(function(event)
    {
      event.preventDefault();
      
      switch(event.currentTarget.id)
      {
        case "btn_relay1_on":
            relay_action("1_on");
            break;
        case "btn_relay1_off":
            relay_action("1_off");
            break;
        case "btn_relay2_on":
            relay_action("2_on");
            break;
        case "btn_relay2_off":
            relay_action("2_off");
            break;
      }
    });
    
    /* Start state loading */
    stateUpdateTick();
});
</script>
</html>
